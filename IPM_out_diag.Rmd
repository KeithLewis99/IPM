---
title: "IPM_out"
author: "Keith Lewis"
date: "21/4/2022"
output:
  flexdashboard::flex_dashboard:
    theme: yeti
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
library(knitr)
library(plotly)
library(ggplot2)
library(crosstalk)
library(xtable)
library(DT)
library(ezknitr)

source("IPM_out.R")
#load("mod_20K.RData")
#load("mod_2M.RData")
options(scipen=999)

```

Background {data-navmenu="Background"}
=====

Column {.tabset}
-------------------------------------

### General

- capelin (Mallotus villosus)
- Nafo division 2J3KL
- keystone forage fish in NA Atlantic
- LRP required

- An integrated state-space population dynamics model  
- Integrated  
     - Uses as much information as possible  
- State-space  
     - Includes process and observation equations + error  
     - Population processes are informed by observations from multiple sources  
     - Process errors are necessary for realistic stochastic projections


### capelin Life cycle

```{r}
knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/lifeCycle_plus_Data.png")
```

### Data time series

```{r}
knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/lifeCycle_dataTimeSeries.png")
```

Study area and Data {data-navmenu="Background"}
=====

Column
-------------------------------------

### Study Area

```{r}
knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/map_inset.png")
```

### The data: temporal relationships

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/variables_plus_fish.png")

```

Column {.tabset}
-------------------------------------

### Dome model

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/Buren2015fig5_dome.png")

```


### Larval density and recruitment

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/Murphy2018FishRes_fig2.png")

```


### Condition

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/Buren_fig6-cond.png")

```

### The forecast model

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/credInt.png")

```



# MCMC info

iterations (ni) = `r ni`  
thining rate (nt) = `r nt`  
burn-in (nb) = `r nb`  
number chains (nc) = `r nc`  


DIC = `r round(ssm26_dic, 1)`

Independence- join probability = product of marginal probabilities

Common Demography Assumption:  The assumption of the IPM is that data sets stem broadly from the same population and that data sets don't have conflicting information.  
Different areas: To my knowledge, there is no evidence that 2J3KL is not one stock - probably OK here.
Different time periods: The regime shift may be an issue - may need to have a time-varying component.  See S&K for references (pg. 289)
Spatial mis-match: larval density is gathered on one beach and extrapolated to the whole stock.  S&K don't elaborate on this.  

Clearly, a tradeoff between Independence and the Common Demography Assumption

# Parameter estimates

Column {.tabset}
-------------------------------------
     
### N2
     
```{r tab1, eval=T,prompt=T, comment = F}
df_keep_rows <- keep_rows("N2", 25)
tab1 <- tabParm(out$summary, df_keep_rows)
datatable(tab1, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```

### N3
```{r tab2, eval=T,prompt=T, comment = F}
df_keep_rows <- keep_rows("N3", 25)
tab2 <- tabParm(out$summary, df_keep_rows)
datatable(tab2, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```

### N4
```{r tab3, eval=T,prompt=T, comment = F}
df_keep_rows <- keep_rows("N4", 25)
tab3 <- tabParm(out$summary, df_keep_rows)
datatable(tab3, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```


# Survey- SA

Column {.tabset}
-------------------------------------

### Age disaggregated index by year (LN)
     
```{r tab4, eval=T,prompt=T, comment = F}
datatable(df_dis_tabLog, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```

### Age disaggregated index by year (real)
     
```{r tab5, eval=T,prompt=T, comment = F}
datatable(df_dis_tab, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```


# Trends

Column
-------------------------------------

### N
     
```{r}
tmp_plot
```

### N2

```{r}
tmpN2_plot
```


Column
-------------------------------------

### N3
     
```{r}
tmpN3_plot
```

### N4

```{r}
tmpN4_plot
```


# Retro


# Diagnostics - Chain mixing

Column {.tabset}
-------------------------------------
     
### Process and observation
     
```{r}
mix_var
```

### demographic

```{r}
mix_vars_Nyear
```

### N2

```{r}
mix_N2
```

### N3

```{r}
mix_N3
```

### N4

```{r}
mix_N4
```


# Diagnostics - Autocorrelation

Column {.tabset}
-------------------------------------
     
### Process and observation
     
```{r}
autocorr_vars_vAR
```

### demographic

```{r}
autocorr_vars_Nyear
```

### N2

```{r}
autocorr_N2
```

### N3

```{r}
autocorr_N3
```

### N4

```{r}
autocorr_N4
```


# Overdispersion
I think that this is only needed for distributions that can be overdispersed like Poisson.  Gamma has a dispersion parameter and normal assumes constant variance.  
But confirm with PDR.
     
# Model validation
     
# residuals with covariates
     
# Results
     
   