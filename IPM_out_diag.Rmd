---
title: "IPM_out"
author: "Keith Lewis"
date: "`r Sys.Date()`"
output:
  flexdashboard::flex_dashboard:
    theme: yeti
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
library(knitr)
library(plotly)
library(ggplot2)
library(crosstalk)
library(xtable)
library(DT)
library(ezknitr)

#ezknit(file = "IPM_out_diag.Rmd", out_dir = "output", fig_dir = "figs")
#output_dir <- "../output"
#rmarkdown::render("IPM_out_diag.Rmd", output_dir = output_dir)

source("IPM_out.R")
#load("mod_20K.RData")
#load("mod_2M.RData")
options(scipen=999)

```

Background {data-navmenu="Background"}
=====

Column {.tabset}
-------------------------------------

### General

- capelin (Mallotus villosus)
- Nafo division 2J3KL
- keystone forage fish in NA Atlantic
- LRP required

- An integrated state-space population dynamics model  
- Integrated  
     - Uses as much information as possible  
- State-space  
     - Includes process and observation equations + error  
     - Population processes are informed by observations from multiple sources  
     - Process errors are necessary for realistic stochastic projections


### capelin Life cycle

```{r}
knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/lifeCycle_plus_Data.png")
```

### Data time series

```{r}
knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/lifeCycle_dataTimeSeries.png")
```

Study area and Data {data-navmenu="Background"}
=====

Column
-------------------------------------

### Study Area

```{r}
knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/map_inset.png")
```

### The data: temporal relationships

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/variables_plus_fish.png")

```

Column {.tabset}
-------------------------------------

### Dome model

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/Buren2015fig5_dome.png")

```

### Larval density and recruitment

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/Murphy2018FishRes_fig2.png")

```

### Condition

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/Buren_fig6-cond.png")

```

### The forecast model

```{r}

knitr::include_graphics("C:/Users/lewiske/Documents/capelin_LRP/analyses/capelinLRP/images/credInt.png")

```


# MCMC info

### Date
Date = `r Sys.Date()`

### JAGS info

Model = `r tC.txt`  
iterations (ni) = `r ni`  
thining rate (nt) = `r nt`  
burn-in (nb) = `r nb`  
number chains (nc) = `r nc`  
parameters = `r parms`

DIC = `r round(ssm26_dic, 1)`

### Other stuff

Independence- join probability = product of marginal probabilities

Common Demography Assumption:  The assumption of the IPM is that data sets stem broadly from the same population and that data sets don't have conflicting information.  
Different areas: To my knowledge, there is no evidence that 2J3KL is not one stock - probably OK here.
Different time periods: The regime shift may be an issue - may need to have a time-varying component.  See S&K for references (pg. 289)
Spatial mis-match: larval density is gathered on one beach and extrapolated to the whole stock.  S&K don't elaborate on this.  

Clearly, a tradeoff between Independence and the Common Demography Assumption

# Parameter estimates

Column {.tabset}
-------------------------------------
     
### N2
     
```{r tab1, eval=T,prompt=T, comment = F}
df_keep_rows <- keep_rows("N2", 25)
tab1 <- tabParm(out$summary, df_keep_rows)
datatable(tab1, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```

### N3
```{r tab2, eval=T,prompt=T, comment = F}
df_keep_rows <- keep_rows("N3", 25)
tab2 <- tabParm(out$summary, df_keep_rows)
datatable(tab2, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```

### N4
```{r tab3, eval=T,prompt=T, comment = F}
df_keep_rows <- keep_rows("N4", 25)
tab3 <- tabParm(out$summary, df_keep_rows)
datatable(tab3, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```

# Survey- SA

Column {.tabset}
-------------------------------------
     
### Age disaggregated index by year (LN)
     
```{r tab4, eval=T,prompt=T, comment = F}
datatable(df_dis_tabLog, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```

### Age disaggregated index by year (real)

```{r tab5, eval=T,prompt=T, comment = F}
datatable(df_dis_tab, rownames = F, class = 'cell-border stripe', height = 50,  options = list(searching = F, pageLength = 30, autoWidth = TRUE, scrollY = F)) %>% formatRound(2:5, 3)
```


# Trends

Column
-------------------------------------
     
### N
     
```{r}
tmp_plot
```

### N2

```{r}
tmpN2_plot
```


Column
-------------------------------------
     
### N3
     
```{r}
tmpN3_plot
```

### N4

```{r}
tmpN4_plot
```


# Retro

# Chain mixing - Diagnostics

Column {.tabset}
-------------------------------------
     
### Process and observation
     
```{r}
mix_var
```

### demographic

```{r}
mix_vars_Nyear
```

### N2

```{r}
mix_N2
```

### N3

```{r}
if (b ==1 | b==2){
     mix_N3  
}
```

### N4

```{r}
if (b ==1){
     mix_N4  
}
```

# Autocorrelation - Diagnostics

Column {.tabset}
-------------------------------------
     
### Process and observation
     
```{r}
autocorr_vars_vAR
```

### demographic

```{r}
autocorr_vars_Nyear
```

### N2

```{r}
autocorr_N2
```

### N3

```{r}
if(b ==1|b ==2){
     autocorr_N3 
}

```

### N4

```{r}
if(b ==1){
     autocorr_N4  
}
```

# Model validation - Diagnostics

Column {.tabset}
-------------------------------------
     
### Posterior predictive checks
The spread should be good and the Bayesian p-value should ~ 0.5 but not near 0 or 1
```{r}
obs_v_rep
```

### Jaggedness
See S&K pg 274 and 279 for explanation
```{r}
hist(out$sims.list$Tturn.rep, xlim = c(7, 22), xlab = "Number of switches \n (replicated data)")
abline(v= out$mean$Tturn.obs, col = "red")
```


# Residuals - Diagnostics {data-navmenu="Residuals - Diagnostics"}
=====================
     
N2

Column 
-------------------------------------
     
```{r}
par(mfrow = c(2,2), mar = c(5,5,2,2))
plot(x=calc$N2[5:25], y = resN2_mean, xlab = "Fitted values", ylab = "Raw residuals")
abline(h = 0, lty = 2)
```

```{r}
# # see notes in Mortality model
plot(y = jd$I2, x = calc$N2, xlab = "Fitted values", ylab = "Observed data") # should follow the line
abline(coef = c(0,1), lty = 2)

```

Column
-------------------------------------
     
```{r}
#normality
histogram(resN2_mean)
```

```{r}
# Cook's D
plot(y = dN2, x = 1:21, xlab = "Observation", ylab = "Cook's D") # should follow the line
```


N3- Residuals - Diagnostics {data-navmenu="Residuals - Diagnostics"}
=====================
     
N4 - Residuals - Diagnostics {data-navmenu="Residuals - Diagnostics"}
=====================


# Covariates - Diagnostics {data-navmenu="Covariates - Diagnostics"}
=====================
     
N2

Column 
-------------------------------------
     
```{r}
plot(jags.data$LD[3:23], resN2_mean, xlab = "Larval Density", ylab = "Pearson resids")
```


Column
-------------------------------------
     
```{r}
plot(jags.data$TI[5:25], resN2_mean, xlab = "Ice retreat", ylab = "Pearson resids")
```

N3 - Covariates - Diagnostics {data-navmenu="Covariates - Diagnostics"}
=====================

```{r}
if (b==1|b==2){
mix_N3 <- MyBUGSChains(out, vars_N3)   
}

```


N4 - Covariates - Diagnostics {data-navmenu="Covariates - Diagnostics"}
=====================

```{r}
plot(jags.data$TI[5:25], resN2_mean, xlab = "Ice retreat", ylab = "Pearson resids")
```

